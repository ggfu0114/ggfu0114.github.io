
<head>
<title>AWS S3 REST 數位簽章與驗證</title>
<meta charset="utf-8" />
<meta name="description" content="利用數位簽章讓使用者可以透過 api resquest 去做身份認可(identity)並操作S3裏面的物件" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="GGFU" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css" integrity="sha512-Oy18vBnbSJkXTndr2n6lDMO5NN31UljR8e/ICzVPrGpSud4Gkckb8yUpqhKuUNoE+o9gAb4O/rAxxw1ojyUVzg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/github-gist.min.css" integrity="sha256-tAflq+ymku3Khs+I/WcAneIlafYgDiOQ9stIHH985Wo=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://ggfu0114.github.io/css/code_block.css"/>
</head>
<style>
	.markdown-body {
		box-sizing: border-box;
		min-width: 200px;
		max-width: 980px;
		margin: 0 auto;
		padding: 45px;
	}

	@media (max-width: 767px) {
		.markdown-body {
			padding: 15px;
		}
	}
</style>
<article class="markdown-body">
	<h1 id="aws-s3-rest">AWS S3 REST簽章與驗證</h1>
<ul>
<li>假設在S3裡的物件只設定給 "authenticated AWS user" 操作，那我們要如何利用數位簽章讓使用者可以透過 api resquest 去做身份認可(identity)並操作S3裏面的物件。</li>
<li>假設在S3上我們有一個name為 wisigntest 的bucket，裏面存在一個名為hello.jpg的物件，設定為 "authenticated AWS user" 可以R/W。我們將紀錄如何使用API去存取S3物件。</li>
</ul>
<blockquote>
<p>簡易瀏覽物件</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="nf">GET</span> <span class="nn">/hello.jpg</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">https://wisigntest.s3-ap-northeast-1.amazonaws.com</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Fri, 28 Apr 2017 05:56:29 GMT</span>

Authorization: AWS AKIAIOSFODNN7EXAMPLE:frJIUN8DYpKDtOLCwo//yllqDzg=
</code></pre></div>

<p>下面是我用Postman去讀取S3檔案的畫面<br />
<img alt="" src="https://i.imgur.com/dnJRA2I.png" /></p>
<blockquote>
<p>The Authentication Header</p>
</blockquote>
<p>下面的格式是主要傳送給 API 的 Header 上要添加的 Authorization 資訊，透過Signature，AWS可以驗證此次的操作是否有效。</p>
<div class="codehilite"><pre><span></span><code><span class="n">Authorization</span><span class="o">:</span><span class="w"> </span><span class="n">AWS</span><span class="w"> </span><span class="o">{</span><span class="n">AWSAccessKeyId</span><span class="o">}:{</span><span class="n">Signature</span><span class="o">}</span><span class="w"></span>
</code></pre></div>

<p>下面是 Nodejs 計算的Signature程式碼</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;crypto&quot;</span><span class="p">);</span><span class="w"></span>

<span class="c1">// from IAM role</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="nx">secret_access_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;64nd6BY7gTPDspq54gQcRth5dvORNdDvqL4BZ5zd&#39;</span><span class="p">;</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="nx">access_key_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;AKIAIUHT2BNZP65ADZKQ&#39;</span><span class="w"></span>

<span class="kd">var</span><span class="w"> </span><span class="nx">StringToSign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;GET&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toUTCString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;/wisigntest/hello.jpg&quot;</span><span class="p">;</span><span class="w"></span>


<span class="kd">var</span><span class="w"> </span><span class="nx">Signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="nx">createHmac</span><span class="p">(</span><span class="s1">&#39;sha1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">secret_access_key</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">StringToSign</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">);</span><span class="w"></span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\n=====Signature=====&quot;</span><span class="p">);</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">Signature</span><span class="p">);</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\n=====StringToSign=====&quot;</span><span class="p">);</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">StringToSign</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

<p>所以 Signature 會因為每分每秒時間的變動，加上每次要操作的行為不一樣而有不同的結果。如果 Header 上Date的數值跟當前的時間差太遠會產生出RequestTimeTooSkewed Error(如下圖)，最多只能延遲15 minutes 進行操作。一旦過期就只能再重新產生一組新的操作。<br />
```yaml=</p>
<?xml version="1.0" encoding="UTF-8"?>
<p><Error><br />
    <Code>RequestTimeTooSkewed</Code><br />
    <Message>The difference between the request time and the current time is too large.</Message><br />
    <RequestTime>Fri, 28 Apr 2017 07:01:06 GMT</RequestTime><br />
    <ServerTime>2017-04-28T07:17:20Z</ServerTime><br />
    <MaxAllowedSkewMilliseconds>900000</MaxAllowedSkewMilliseconds><br />
    <RequestId>A1CC38F343F62CB3</RequestId><br />
    <HostId>mJYpxdY5MthZwY4NUeF/MTIcJbYPpZ+6+haAfHkn40AX32XMrP618pzOv+MsZvAE965jaM1OgCk=</HostId><br />
</Error></p>
<div class="codehilite"><pre><span></span><code><span class="o">&gt;</span><span class="w"> </span><span class="err">利用</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">form</span><span class="w"> </span><span class="err">上傳檔案到</span><span class="w"> </span><span class="n">S3</span><span class="w"></span>

<span class="o">-</span><span class="w"> </span><span class="err">如果今天有一個檔案叫</span><span class="w"> </span><span class="n">hello1</span><span class="o">.</span><span class="n">js要上傳到S3的</span><span class="w"> </span><span class="n">wisigntest</span><span class="w"> </span><span class="n">bucket</span><span class="w"> </span><span class="err">裡，可以依照以下步驟去執行</span><span class="w"></span>


<span class="o">!</span><span class="p">[](</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">i</span><span class="o">.</span><span class="n">imgur</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">KFIxuR7</span><span class="o">.</span><span class="n">png</span><span class="p">)</span><span class="w"></span>
<span class="o">!</span><span class="p">[](</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">i</span><span class="o">.</span><span class="n">imgur</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">Y1zmUks</span><span class="o">.</span><span class="n">png</span><span class="p">)</span><span class="w"></span>

<span class="err">在</span><span class="w"> </span><span class="n">Postman</span><span class="w"> </span><span class="err">上做發送照片的</span><span class="w"> </span><span class="n">request</span><span class="err">，</span><span class="n">Header參數上依然要填上</span><span class="w"> </span><span class="n">Authorization</span><span class="p">,</span><span class="w"> </span><span class="n">Date參數</span><span class="err">，</span><span class="n">Content</span><span class="o">-</span><span class="n">Type填上</span><span class="s2">&quot;text/plain&quot;</span><span class="err">。</span><span class="w"></span>


<span class="err">```</span><span class="n">javascript</span><span class="w"></span>
<span class="k">var</span><span class="w"> </span><span class="n">StringToSign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PUT&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;text/plain&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="n">new</span><span class="w"> </span><span class="n">Date</span><span class="p">()</span><span class="o">.</span><span class="n">toUTCString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;/wisigntest/hello1.jpg&quot;</span><span class="p">;</span><span class="w"></span>
</code></pre></div>

<p>只要把上面的 "StringToSign" 變數改成上面所序，就可以產出正確的 Signature 了</p>
<blockquote>
<p>沒有 Header 的 request authentication</p>
</blockquote>
<p>此外 S3 提供不需帶 Header 的存取方法。基本上是將Date用Expires取代，然後所有的參數都放置在 URL 上。例如下方的 URL，主要的參數有 AWSAccessKeyId, Expires, Signature。AWSAccessKeyId 跟 Signature 的產出原理一樣，Expires 則是當前的 Timestamp 再加上預期 URL 失效的時間。 </p>
<p>:::success<br />
https://wisigntest.s3-ap-northeast-1.amazonaws.com/hello.jpg?AWSAccessKeyId=AKIAIUHT2BNZP65ADZKQ&amp;Expires=1493368109&amp;Signature=xLO3tdF%2FAutv%2BYinCfA7G8C157E%3D<br />
:::</p>
<p>產出 Signature 需要將 Date 變數取代為預期失效的 Timestamp 時間。下面的例子即是當前時間加上 600 Seconds 時，URL 就會失效。</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">StringToSign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;GET&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="nb">parseInt</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000</span><span class="o">+</span><span class="mf">600</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;/wisigntest/hello.jpg&quot;</span><span class="p">;</span><span class="w"></span>
</code></pre></div>

<ul>
<li>參考資料<br />
<a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/RESTAuthentication.html">AWS S3 Signing and Authenticating REST Requests</a></li>
</ul>
<h6 id="tags-s3-presign-rest">tags: <code>S3</code>, <code>presign</code>, <code>REST</code>,</h6>
</article>
