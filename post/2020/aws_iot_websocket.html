
<head>
<title>AWS IoT with websocket</title>
<meta charset="utf-8" />
<meta name="description" content="AWS在IoT的服務上也有做到MQTT Over the WebSocket Protocol，透過AWS SigV4的身份認證, 利用Port 443，我們可以透過網頁連線上AWS IoT的服務" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="GGFU" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css" integrity="sha512-Oy18vBnbSJkXTndr2n6lDMO5NN31UljR8e/ICzVPrGpSud4Gkckb8yUpqhKuUNoE+o9gAb4O/rAxxw1ojyUVzg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/github-gist.min.css" integrity="sha256-tAflq+ymku3Khs+I/WcAneIlafYgDiOQ9stIHH985Wo=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://ggfu0114.github.io/css/code_block.css"/>
</head>
<style>
	.markdown-body {
		box-sizing: border-box;
		min-width: 200px;
		max-width: 980px;
		margin: 0 auto;
		padding: 45px;
	}

	@media (max-width: 767px) {
		.markdown-body {
			padding: 15px;
		}
	}
</style>
<article class="markdown-body">
	<h1 id="aws-iot-with-websocket">AWS IoT with websocket</h1>
<ul>
<li>在大多數的瀏覽器都有支援websocket的protocol前提下，實作網頁即時接收訊息的功能上，我們希望每個網頁都可以當作是一個mqtt的裝置，如此一來就可以即時推播給各個網頁，也可以即時的接收到來自client端的訊息。</li>
<li>AWS在IoT的服務上也有做到MQTT Over the WebSocket Protocol，透過AWS SigV4的身份認證, 利用Port 443，我們可以透過網頁連線上AWS IoT的服務。</li>
</ul>
<blockquote>
<p>server side<br />
- 以下是server端需要產出帶有authentication的query url，使用上，前端只需要將url用get的方式呼叫就可以連接上IoT。<br />
```javascript=<br />
function SigV4Utils() {}</p>
</blockquote>
<p>SigV4Utils.getSignatureKey = function (key, date, region, service) {<br />
    var kDate = AWS.util.crypto.hmac('AWS4' + key, date, 'buffer');<br />
    var kRegion = AWS.util.crypto.hmac(kDate, region, 'buffer');<br />
    var kService = AWS.util.crypto.hmac(kRegion, service, 'buffer');<br />
    var kCredentials = AWS.util.crypto.hmac(kService, 'aws4_request', 'buffer');  <br />
    return kCredentials;<br />
};</p>
<p>SigV4Utils.getSignedUrl = function(host, region, <br />
                                   ) {<br />
    var datetime = AWS.util.date.iso8601(new Date()).replace(/[:-]|.\d{3}/g, '');<br />
    var date = datetime.substr(0, 8);</p>
<div class="codehilite"><pre><span></span><code><span class="k">var</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span><span class="p">;</span>
<span class="k">var</span> <span class="n">protocol</span> <span class="o">=</span> <span class="s1">&#39;wss&#39;</span><span class="p">;</span>
<span class="k">var</span> <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;/mqtt&#39;</span><span class="p">;</span>
<span class="k">var</span> <span class="n">service</span> <span class="o">=</span> <span class="s1">&#39;iotdevicegateway&#39;</span><span class="p">;</span>
<span class="k">var</span> <span class="n">algorithm</span> <span class="o">=</span> <span class="s1">&#39;AWS4-HMAC-SHA256&#39;</span><span class="p">;</span>

<span class="k">var</span> <span class="n">credentialScope</span> <span class="o">=</span> <span class="n">date</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">region</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">service</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;aws4_request&#39;</span><span class="p">;</span>
<span class="k">var</span> <span class="n">canonicalQuerystring</span> <span class="o">=</span> <span class="s1">&#39;X-Amz-Algorithm=&#39;</span> <span class="o">+</span> <span class="n">algorithm</span><span class="p">;</span>
<span class="n">canonicalQuerystring</span> <span class="o">+=</span> <span class="s1">&#39;&amp;X-Amz-Credential=&#39;</span> <span class="o">+</span> <span class="n">encodeURIComponent</span><span class="p">(</span><span class="n">credentials</span><span class="o">.</span><span class="n">accessKeyId</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">credentialScope</span><span class="p">);</span>
<span class="n">canonicalQuerystring</span> <span class="o">+=</span> <span class="s1">&#39;&amp;X-Amz-Date=&#39;</span> <span class="o">+</span> <span class="n">datetime</span><span class="p">;</span>
<span class="n">canonicalQuerystring</span> <span class="o">+=</span> <span class="s1">&#39;&amp;X-Amz-SignedHeaders=host&#39;</span><span class="p">;</span>

<span class="k">var</span> <span class="n">canonicalHeaders</span> <span class="o">=</span> <span class="s1">&#39;host:&#39;</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">;</span>
<span class="k">var</span> <span class="n">payloadHash</span> <span class="o">=</span> <span class="n">AWS</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;hex&#39;</span><span class="p">)</span>
<span class="k">var</span> <span class="n">canonicalRequest</span> <span class="o">=</span> <span class="n">method</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">uri</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">canonicalQuerystring</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">canonicalHeaders</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">host</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">payloadHash</span><span class="p">;</span>

<span class="k">var</span> <span class="n">stringToSign</span> <span class="o">=</span> <span class="n">algorithm</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">datetime</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">credentialScope</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">AWS</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">canonicalRequest</span><span class="p">,</span> <span class="s1">&#39;hex&#39;</span><span class="p">);</span>
<span class="k">var</span> <span class="n">signingKey</span> <span class="o">=</span> <span class="n">SigV4Utils</span><span class="o">.</span><span class="n">getSignatureKey</span><span class="p">(</span><span class="n">credentials</span><span class="o">.</span><span class="n">secretAccessKey</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>
<span class="k">var</span> <span class="n">signature</span> <span class="o">=</span> <span class="n">AWS</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">hmac</span><span class="p">(</span><span class="n">signingKey</span><span class="p">,</span> <span class="n">stringToSign</span><span class="p">,</span> <span class="s1">&#39;hex&#39;</span><span class="p">);</span>

<span class="n">canonicalQuerystring</span> <span class="o">+=</span> <span class="s1">&#39;&amp;X-Amz-Signature=&#39;</span> <span class="o">+</span> <span class="n">signature</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">credentials</span><span class="o">.</span><span class="n">sessionToken</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">canonicalQuerystring</span> <span class="o">+=</span> <span class="s1">&#39;&amp;X-Amz-Security-Token=&#39;</span> <span class="o">+</span> <span class="n">encodeURIComponent</span><span class="p">(</span><span class="n">credentials</span><span class="o">.</span><span class="n">sessionToken</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">var</span> <span class="n">requestUrl</span> <span class="o">=</span> <span class="n">protocol</span> <span class="o">+</span> <span class="s1">&#39;://&#39;</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="n">uri</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="n">canonicalQuerystring</span><span class="p">;</span>
<span class="k">return</span> <span class="n">requestUrl</span><span class="p">;</span>
</code></pre></div>

<p>};</p>
<div class="codehilite"><pre><span></span><code><span class="o">-</span> <span class="err">`</span><span class="n">host</span><span class="err">`</span><span class="p">:</span> <span class="n">IoT的endpoint</span><span class="p">,</span> <span class="err">例如：</span><span class="n">ag35axgb1wdct</span><span class="o">.</span><span class="n">iot</span><span class="o">.</span><span class="n">ap</span><span class="o">-</span><span class="n">northeast</span><span class="o">-</span><span class="mf">1.</span><span class="n">amazonaws</span><span class="o">.</span><span class="n">com</span>
<span class="o">-</span> <span class="err">`</span><span class="n">region</span><span class="err">`</span><span class="p">:</span> <span class="n">IoT</span> <span class="n">service所在區域</span><span class="err">，例如：</span><span class="n">ap</span><span class="o">-</span><span class="n">northeast</span><span class="o">-</span><span class="mi">1</span>
<span class="o">-</span> <span class="err">`</span><span class="n">credentials</span><span class="err">`</span><span class="p">:</span> <span class="n">accessKeyId</span><span class="p">,</span> <span class="n">secretAccessKey</span><span class="p">,</span> <span class="n">sessionToken</span><span class="p">(</span><span class="n">optional</span><span class="p">)</span> <span class="n">IAM角色的公私鑰</span>

<span class="o">&gt;</span> <span class="n">client</span> <span class="n">side</span>
<span class="o">-</span> <span class="err">前端只要利用</span><span class="n">API的方式去向server取的IoT</span> <span class="n">url並取代掉</span><span class="err">`</span><span class="p">{</span><span class="n">URL_FROM_SERVER</span><span class="p">}</span><span class="err">`就可以進行連線。修改連線的</span><span class="n">topic只需要取代掉</span><span class="err">`</span><span class="n">Test</span><span class="o">/</span><span class="n">chat</span><span class="err">`即可。</span>
<span class="err">```</span><span class="n">htmlmixed</span><span class="o">=</span>
<span class="o">&lt;!</span><span class="n">DOCTYPE</span> <span class="n">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">html</span> <span class="n">lang</span><span class="o">=</span><span class="s2">&quot;EN&quot;</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">meta</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;text/html;charset=utf-8&quot;</span> <span class="n">http</span><span class="o">-</span><span class="n">equiv</span><span class="o">=</span><span class="s2">&quot;Content-Type&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">meta</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span> <span class="n">http</span><span class="o">-</span><span class="n">equiv</span><span class="o">=</span><span class="s2">&quot;encoding&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">ul</span> <span class="n">id</span><span class="o">=</span><span class="s2">&quot;chat&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">li</span> <span class="n">v</span><span class="o">-</span><span class="k">for</span><span class="o">=</span><span class="s2">&quot;m in messages&quot;</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">m</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">input</span> <span class="n">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;say&quot;</span> <span class="n">id</span><span class="o">=</span><span class="s2">&quot;say&quot;</span> <span class="n">placeholder</span><span class="o">=</span><span class="s2">&quot;Input a message here...&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">button</span> <span class="n">id</span><span class="o">=</span><span class="s2">&quot;send&quot;</span><span class="o">&gt;</span><span class="n">Send</span><span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.16/vue.min.js&quot;</span> <span class="n">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js&quot;</span> <span class="n">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/core-min.js&quot;</span> <span class="n">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/hmac-min.js&quot;</span> <span class="n">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/sha256-min.js&quot;</span> <span class="n">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js&quot;</span> <span class="n">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">script</span> <span class="n">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;</span>
        <span class="k">var</span> <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">messages</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">};</span>
        <span class="n">new</span> <span class="n">Vue</span><span class="p">({</span>
            <span class="n">el</span><span class="p">:</span> <span class="s1">&#39;#chat&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="p">:</span> <span class="n">data</span>
        <span class="p">});</span>
        <span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s1">&#39;send&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="n">function</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">var</span> <span class="n">say</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s1">&#39;say&#39;</span><span class="p">)</span>
            <span class="n">send</span><span class="p">(</span><span class="n">say</span><span class="o">.</span><span class="n">value</span><span class="p">);</span>
            <span class="n">say</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="p">});</span>
<span class="k">var</span> <span class="n">clientId</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span><span class="o">.</span><span class="n">substring</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
        <span class="k">var</span> <span class="n">client</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Paho</span><span class="o">.</span><span class="n">MQTT</span><span class="o">.</span><span class="n">Client</span><span class="p">({</span><span class="n">URL_FROM_SERVER</span><span class="p">},</span> <span class="n">clientId</span><span class="p">);</span>
        <span class="k">var</span> <span class="n">topicName</span> <span class="o">=</span> <span class="s1">&#39;Test/chat&#39;</span><span class="p">;</span>
        <span class="k">var</span> <span class="n">connectOptions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">useSSL</span><span class="p">:</span> <span class="bp">true</span><span class="p">,</span>
            <span class="n">timeout</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="n">mqttVersion</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="n">onSuccess</span><span class="p">:</span> <span class="n">subscribe</span>
        <span class="p">};</span>
        <span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">connectOptions</span><span class="p">);</span>
        <span class="n">client</span><span class="o">.</span><span class="n">onMessageArrived</span> <span class="o">=</span> <span class="n">onMessage</span><span class="p">;</span>
        <span class="n">client</span><span class="o">.</span><span class="n">onConnectionLost</span> <span class="o">=</span> <span class="n">function</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">};</span>
        <span class="n">function</span> <span class="n">subscribe</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">client</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">topicName</span><span class="p">);</span>
            <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;subscribed on Topic&quot;</span><span class="p">,</span> <span class="n">topicName</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">function</span> <span class="n">send</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">var</span> <span class="n">message</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Paho</span><span class="o">.</span><span class="n">MQTT</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span><span class="n">content</span><span class="p">);</span>
            <span class="n">message</span><span class="o">.</span><span class="n">destinationName</span> <span class="o">=</span> <span class="n">topicName</span><span class="p">;</span>
            <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
            <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;sent to Topic&quot;</span><span class="p">,</span> <span class="n">topicName</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">function</span> <span class="n">onMessage</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">data</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">payloadString</span><span class="p">);</span>
            <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;message received: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="o">.</span><span class="n">payloadString</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>

<span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
</code></pre></div>

<h6 id="tags-aws-iot-websocket-sigv4">tags: <code>AWS</code>, <code>IoT</code>, <code>websocket</code>, <code>SigV4</code></h6>
</article>
