
<head>
<title>AWS IoT with websocket</title>
<meta charset="utf-8" />
<meta name="description" content="AWS在IoT的服務上也有做到MQTT Over the WebSocket Protocol，透過AWS SigV4的身份認證, 利用Port 443，我們可以透過網頁連線上AWS IoT的服務" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="GGFU" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css" integrity="sha512-Oy18vBnbSJkXTndr2n6lDMO5NN31UljR8e/ICzVPrGpSud4Gkckb8yUpqhKuUNoE+o9gAb4O/rAxxw1ojyUVzg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/github-gist.min.css" integrity="sha256-tAflq+ymku3Khs+I/WcAneIlafYgDiOQ9stIHH985Wo=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://ggfu0114.github.io/css/code_block.css"/>
</head>
<style>
	.markdown-body {
		box-sizing: border-box;
		min-width: 200px;
		max-width: 980px;
		margin: 0 auto;
		padding: 45px;
	}

	@media (max-width: 767px) {
		.markdown-body {
			padding: 15px;
		}
	}
</style>
<article class="markdown-body">
	<h1 id="aws-iot-with-websocket">AWS IoT with websocket</h1>
<ul>
<li>在大多數的瀏覽器都有支援websocket的protocol前提下，實作網頁即時接收訊息的功能上，我們希望每個網頁都可以當作是一個mqtt的裝置，如此一來就可以即時推播給各個網頁，也可以即時的接收到來自client端的訊息。</li>
<li>AWS在IoT的服務上也有做到MQTT Over the WebSocket Protocol，透過AWS SigV4的身份認證, 利用Port 443，我們可以透過網頁連線上AWS IoT的服務。</li>
</ul>
<blockquote>
<p>server side<br />
- 以下是server端需要產出帶有authentication的query url，使用上，前端只需要將url用get的方式呼叫就可以連接上IoT。</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">SigV4Utils</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="nx">SigV4Utils</span><span class="p">.</span><span class="nx">getSignatureKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">date</span><span class="p">,</span><span class="w"> </span><span class="nx">region</span><span class="p">,</span><span class="w"> </span><span class="nx">service</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">kDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">AWS</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">hmac</span><span class="p">(</span><span class="s1">&#39;AWS4&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">date</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;buffer&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">kRegion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">AWS</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">hmac</span><span class="p">(</span><span class="nx">kDate</span><span class="p">,</span><span class="w"> </span><span class="nx">region</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;buffer&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">kService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">AWS</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">hmac</span><span class="p">(</span><span class="nx">kRegion</span><span class="p">,</span><span class="w"> </span><span class="nx">service</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;buffer&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">kCredentials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">AWS</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">hmac</span><span class="p">(</span><span class="nx">kService</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;aws4_request&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;buffer&#39;</span><span class="p">);</span><span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">kCredentials</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="nx">SigV4Utils</span><span class="p">.</span><span class="nx">getSignedUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">region</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                   </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">datetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">AWS</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">iso8601</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[:\-]|\.\d{3}/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">datetime</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;GET&#39;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">protocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;wss&#39;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;/mqtt&#39;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;iotdevicegateway&#39;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">algorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;AWS4-HMAC-SHA256&#39;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">credentialScope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">date</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">region</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;aws4_request&#39;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">canonicalQuerystring</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;X-Amz-Algorithm=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">algorithm</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="nx">canonicalQuerystring</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s1">&#39;&amp;X-Amz-Credential=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">credentials</span><span class="p">.</span><span class="nx">accessKeyId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">credentialScope</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="nx">canonicalQuerystring</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s1">&#39;&amp;X-Amz-Date=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">datetime</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="nx">canonicalQuerystring</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s1">&#39;&amp;X-Amz-SignedHeaders=host&#39;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">canonicalHeaders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;host:&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">host</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">payloadHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">AWS</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">sha256</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;hex&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">canonicalRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">method</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">uri</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">canonicalQuerystring</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">canonicalHeaders</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;\nhost\n&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">payloadHash</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">stringToSign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">algorithm</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">datetime</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">credentialScope</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">AWS</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">sha256</span><span class="p">(</span><span class="nx">canonicalRequest</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;hex&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">signingKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">SigV4Utils</span><span class="p">.</span><span class="nx">getSignatureKey</span><span class="p">(</span><span class="nx">credentials</span><span class="p">.</span><span class="nx">secretAccessKey</span><span class="p">,</span><span class="w"> </span><span class="nx">date</span><span class="p">,</span><span class="w"> </span><span class="nx">region</span><span class="p">,</span><span class="w"> </span><span class="nx">service</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">AWS</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">hmac</span><span class="p">(</span><span class="nx">signingKey</span><span class="p">,</span><span class="w"> </span><span class="nx">stringToSign</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;hex&#39;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="nx">canonicalQuerystring</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s1">&#39;&amp;X-Amz-Signature=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">signature</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">credentials</span><span class="p">.</span><span class="nx">sessionToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">canonicalQuerystring</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s1">&#39;&amp;X-Amz-Security-Token=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">credentials</span><span class="p">.</span><span class="nx">sessionToken</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">requestUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">protocol</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;://&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">host</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">uri</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;?&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">canonicalQuerystring</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">requestUrl</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>

<ul>
<li><code>host</code>: IoT的endpoint, 例如：ag35axgb1wdct.iot.ap-northeast-1.amazonaws.com</li>
<li><code>region</code>: IoT service所在區域，例如：ap-northeast-1</li>
<li><code>credentials</code>: accessKeyId, secretAccessKey, sessionToken(optional) IAM角色的公私鑰</li>
</ul>
<blockquote>
<p>client side<br />
- 前端只要利用API的方式去向server取的IoT url並取代掉<code>{URL_FROM_SERVER}</code>就可以進行連線。修改連線的topic只需要取代掉<code>Test/chat</code>即可。<br />
```htmlmixed=</p>
</blockquote>
<!DOCTYPE html>
<p><html lang="EN"></p>
<p><head><br />
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"><br />
    <meta content="utf-8" http-equiv="encoding"><br />
</head></p>
<body>
    <ul id="chat">
        <li v-for="m in messages">{{ m }}</li>
    </ul>
    <input type="text" name="say" id="say" placeholder="Input a message here...">
    <button id="send">Send</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.16/vue.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/core-min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/hmac-min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/sha256-min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
    <script type="text/javascript">
        var data = {
            messages: []
        };
        new Vue({
            el: '#chat',
            data: data
        });
        document.getElementById('send').addEventListener('click', function (e) {
            var say = document.getElementById('say')
            send(say.value);
            say.value = '';
        });
var clientId = Math.random().toString(36).substring(7);
        var client = new Paho.MQTT.Client({URL_FROM_SERVER}, clientId);
        var topicName = 'Test/chat';
        var connectOptions = {
            useSSL: true,
            timeout: 3,
            mqttVersion: 4,
            onSuccess: subscribe
        };
        client.connect(connectOptions);
        client.onMessageArrived = onMessage;
        client.onConnectionLost = function (e) { console.log(e) };
        function subscribe() {
            client.subscribe(topicName);
            console.log("subscribed on Topic", topicName);
        }
        function send(content) {
            var message = new Paho.MQTT.Message(content);
            message.destinationName = topicName;
            client.send(message);
            console.log("sent to Topic", topicName);
        }
        function onMessage(message) {
            data.messages.push(message.payloadString);
            console.log("message received: " + message.payloadString);
        }
    </script>
</body>

<p></html><br />
```</p>
<h6 id="tags-aws-iot-websocket-sigv4">tags: <code>AWS</code>, <code>IoT</code>, <code>websocket</code>, <code>SigV4</code></h6>
</article>
