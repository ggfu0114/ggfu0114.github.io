<!doctype html><html lang=zh-tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=google-site-verification content="pnTK47Sz1tOdy6JvEhg4vyljdZ7i9uljteeuHXxekyY"><title>Kubeflow Mnist範例介紹 | GGfu Personal Study - 學習筆記</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="利用簡單的mnist來做為範例，介紹如何在Kubeflow進行training跟serving的流程。Kubeflow利用argo workflow將整個流程寫成腳本，透過指令驅動整個AI training與serving過程"><meta name=generator content="Hugo 0.101.0"><meta name=robots content="index, follow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="Kubeflow Mnist範例介紹"><meta property="og:description" content="利用簡單的mnist來做為範例，介紹如何在Kubeflow進行training跟serving的流程。Kubeflow利用argo workflow將整個流程寫成腳本，透過指令驅動整個AI training與serving過程"><meta property="og:type" content="article"><meta property="og:url" content="https://ggfu0114.github.io/posts/kf_minst/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-12-31T00:00:00+00:00"><meta property="article:modified_time" content="2020-12-31T00:00:00+00:00"><meta itemprop=name content="Kubeflow Mnist範例介紹"><meta itemprop=description content="利用簡單的mnist來做為範例，介紹如何在Kubeflow進行training跟serving的流程。Kubeflow利用argo workflow將整個流程寫成腳本，透過指令驅動整個AI training與serving過程"><meta itemprop=datePublished content="2020-12-31T00:00:00+00:00"><meta itemprop=dateModified content="2020-12-31T00:00:00+00:00"><meta itemprop=wordCount content="193"><meta itemprop=keywords content="seldon-core,kubeflow,argo,tfjob,model,AI,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Kubeflow Mnist範例介紹"><meta name=twitter:description content="利用簡單的mnist來做為範例，介紹如何在Kubeflow進行training跟serving的流程。Kubeflow利用argo workflow將整個流程寫成腳本，透過指令驅動整個AI training與serving過程"></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">GGfu Personal Study - 學習筆記</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/categories/ title="Category page">Category</a></li></ul><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">Kubeflow Mnist範例介紹</h1><p class=tracked>By <strong>GGFU</strong></p><time class="f6 mv4 dib tracked" datetime=2020-12-31T00:00:00Z>December 31, 2020</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p><img src=https://cdn-images-1.medium.com/max/1000/1*akWVsdGH6XW9SgDIiePq4Q.png alt></p><p>官網的Git：<a href=https://github.com/kubeflow/example-seldon>kubeflow mnist</a></p><ul><li>利用簡單的mnist來做為範例，介紹如何在Kubeflow進行training跟serving的流程。Kubeflow利用argo workflow將整個流程寫成腳本，透過指令驅動整個AI training與serving過程。training階段會將訓練model的程式碼包成docker image，建立TFjob將model訓練出來。serving階段，會將訓練好的model利用seldon-core的幫助，建立起prediction服務。</li></ul><h3 id=training-的流程>Training 的流程</h3><ol><li>將training的程式從git上載下來，打包成training image</li><li>將打包好的image推上去docker registry</li><li>利用TFjob執行image產生model</li><li>將model給volume出來</li></ol><h3 id=serving-的流程>Serving 的流程</h3><ol><li>將serving的程式從git上載下來，打包成serving image</li><li>將打包好的image推上去docker registry</li><li>將剛train好的model給volume到seldon-core的image上</li><li>透過定義seldon graph啟動predict的機制</li></ol><h3 id=測試>測試</h3><p>可以利用<strong>seldon-core</strong>出的測試工具來檢視predict serving是否正確執行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ seldon-core-api-tester --ambassador-path /seldon/kubeflow/mnist-classifier -p contract.json &lt;host ip&gt; &lt;host port&gt;
</span></span></code></pre></div><h3 id=debug>Debug</h3><blockquote><p>錯誤訊息：</p></blockquote><pre tabindex=0><code>error when creating &#34;/tmp/manifest.yaml&#34;: tfjobs.kubeflow.org is forbidden: User &#34;system:serviceaccount:kubeflow:default&#34; cannot create tfjobs.kubeflow.org in the namespace &#34;kubeflow&#34;
</code></pre><ul><li>將kubeflow namespace的帳號default 加上cluster-admin的權限</li></ul><pre tabindex=0><code>kubectl create clusterrolebinding sa-admin --clusterrole=cluster-admin --serviceaccount=kubeflow:default
</code></pre><blockquote><p>錯誤訊息：</p></blockquote><pre tabindex=0><code> Failed to submit workflow: workflows.argoproj.io is forbidden: User &#34;system:serviceaccount:kubeflow:jupyter-notebook&#34; cannot create workflows.argoproj.io in the namespace &#34;kubeflow&#34;
</code></pre><p>因為jupyter的pod，serviceaccount預設為<code>jupyter-notebook</code>，綁定這個serviceaccount的role為<code>jupyter-notebook-role</code>，如果把<code>jupyter-notebook-role</code>資訊顯示出來看為</p><pre tabindex=0><code>Name:         jupyter-notebook-role
Labels:       app.kubernetes.io/deploy-manager=ksonnet
              ksonnet.io/component=jupyterhub
Annotations:  ksonnet.io/managed={&#34;pristine&#34;:&#34;H4sIAAAAAAAA/4SQvU4rMRCF+/sYp4ycvUqH9gXoKWjQFuPdgTjr9VjjcSBEeXfkRQiJLdLZc873+ecKyuGZtQRJ6KGexo6qHUXDJ1mQ1M0PpQvy/3zwbHSAwxzShB5PEhkOCxtNZIT+ikieY2mruUhKbA0cZcmSOBl6nGq+...
PolicyRule:
  Resources               Non-Resource URLs  Resource Names  Verbs
  -------               -------------  -----------  ----
  deployments             []                 []              [*]
  pods                    []                 []              [*]
  replicasets             []                 []              [*]
  services                []                 []              [*]
  deployments.apps        []                 []              [*]
  replicasets.apps        []                 []              [*]
  jobs.batch              []                 []              [*]
  deployments.extensions  []                 []              [*]
  replicasets.extensions  []                 []              [*]
  *.kubeflow.org          []                 []              [*]
</code></pre><p>缺少了<code>workflows.argoproj.io</code>這個操作Argo的resource權限，所以我們可以透過編輯這個role來解決這個問題。在role的rule裡面加上：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>apiGroups</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>argoproj.io</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>workflows</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>workflows/finalizers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>verbs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#e6db74>&#39;*&#39;</span>
</span></span></code></pre></div><ul><li>需要建立docker registery的帳號密碼。<a href=https://github.com/kubeflow/example-seldon/blob/master/k8s_setup/docker-credentials-secret.yaml.tpl>docker-credentials-secret.yaml</a></li></ul><pre tabindex=0><code>apiVersion: v1
data:
  password: &lt;base 64 password&gt;
  username: &lt;base 64 username&gt;
kind: Secret
metadata:
  name: docker-credentials
  namespace: default
type: Opaque
</code></pre><ul><li>需要先建立nfs讓training放置訓練完的model。 <a href=https://github.com/kubeflow/example-seldon/blob/master/nfs.md>nfs.</a></li></ul><pre tabindex=0><code>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nfs-1
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: nfs-client
  resources:
    requests:
      storage: 30Gi
</code></pre><ul class=pa0><li class="list di"><a href=/tags/seldon-core class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">seldon-core</a></li><li class="list di"><a href=/tags/kubeflow class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">kubeflow</a></li><li class="list di"><a href=/tags/argo class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">argo</a></li><li class="list di"><a href=/tags/tfjob class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">tfjob</a></li><li class="list di"><a href=/tags/model class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">model</a></li><li class="list di"><a href=/tags/ai class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">AI</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://ggfu0114.github.io/>&copy; GGfu Personal Study - 學習筆記 2022</a><div><div class=ananke-socials></div></div></div></footer></body></html>