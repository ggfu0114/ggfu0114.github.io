<!doctype html><html lang=zh-tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>AWS IoT with websocket | GGfu Personal Study - 學習筆記</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="AWS在IoT的服務上也有做到MQTT Over the WebSocket Protocol，透過AWS SigV4的身份認證, 利用Port 443，我們可以透過網頁連線上AWS IoT的服務"><meta name=generator content="Hugo 0.100.2"><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="AWS IoT with websocket"><meta property="og:description" content="AWS在IoT的服務上也有做到MQTT Over the WebSocket Protocol，透過AWS SigV4的身份認證, 利用Port 443，我們可以透過網頁連線上AWS IoT的服務"><meta property="og:type" content="article"><meta property="og:url" content="https://ggfu0114.github.io/posts/aws_iot_websocket/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-12-31T00:00:00+00:00"><meta property="article:modified_time" content="2020-12-31T00:00:00+00:00"><meta itemprop=name content="AWS IoT with websocket"><meta itemprop=description content="AWS在IoT的服務上也有做到MQTT Over the WebSocket Protocol，透過AWS SigV4的身份認證, 利用Port 443，我們可以透過網頁連線上AWS IoT的服務"><meta itemprop=datePublished content="2020-12-31T00:00:00+00:00"><meta itemprop=dateModified content="2020-12-31T00:00:00+00:00"><meta itemprop=wordCount content="399"><meta itemprop=keywords content="AWS,IoT,websocket,SigV4,"><meta name=twitter:card content="summary"><meta name=twitter:title content="AWS IoT with websocket"><meta name=twitter:description content="AWS在IoT的服務上也有做到MQTT Over the WebSocket Protocol，透過AWS SigV4的身份認證, 利用Port 443，我們可以透過網頁連線上AWS IoT的服務"></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">GGfu Personal Study - 學習筆記</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/categories/ title="Category page">Category</a></li></ul><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">AWS IoT with websocket</h1><p class=tracked>By <strong>GGFU</strong></p><time class="f6 mv4 dib tracked" datetime=2020-12-31T00:00:00Z>December 31, 2020</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h1 id=aws-iot-with-websocket>AWS IoT with websocket</h1><ul><li>在大多數的瀏覽器都有支援websocket的protocol前提下，實作網頁即時接收訊息的功能上，我們希望每個網頁都可以當作是一個mqtt的裝置，如此一來就可以即時推播給各個網頁，也可以即時的接收到來自client端的訊息。</li><li>AWS在IoT的服務上也有做到MQTT Over the WebSocket Protocol，透過AWS SigV4的身份認證, 利用Port 443，我們可以透過網頁連線上AWS IoT的服務。</li></ul><blockquote><p>server side</p></blockquote><ul><li>以下是server端需要產出帶有authentication的query url，使用上，前端只需要將url用get的方式呼叫就可以連接上IoT。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>SigV4Utils</span>() {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>SigV4Utils</span>.<span style=color:#a6e22e>getSignatureKey</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>date</span>, <span style=color:#a6e22e>region</span>, <span style=color:#a6e22e>service</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>kDate</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>AWS</span>.<span style=color:#a6e22e>util</span>.<span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>hmac</span>(<span style=color:#e6db74>&#39;AWS4&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>date</span>, <span style=color:#e6db74>&#39;buffer&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>kRegion</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>AWS</span>.<span style=color:#a6e22e>util</span>.<span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>hmac</span>(<span style=color:#a6e22e>kDate</span>, <span style=color:#a6e22e>region</span>, <span style=color:#e6db74>&#39;buffer&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>kService</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>AWS</span>.<span style=color:#a6e22e>util</span>.<span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>hmac</span>(<span style=color:#a6e22e>kRegion</span>, <span style=color:#a6e22e>service</span>, <span style=color:#e6db74>&#39;buffer&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>kCredentials</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>AWS</span>.<span style=color:#a6e22e>util</span>.<span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>hmac</span>(<span style=color:#a6e22e>kService</span>, <span style=color:#e6db74>&#39;aws4_request&#39;</span>, <span style=color:#e6db74>&#39;buffer&#39;</span>);    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>kCredentials</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>SigV4Utils</span>.<span style=color:#a6e22e>getSignedUrl</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>host</span>, <span style=color:#a6e22e>region</span>, 
</span></span><span style=display:flex><span>                                   ) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>datetime</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>AWS</span>.<span style=color:#a6e22e>util</span>.<span style=color:#a6e22e>date</span>.<span style=color:#a6e22e>iso8601</span>(<span style=color:#66d9ef>new</span> Date()).<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/[:\-]|\.\d{3}/g</span>, <span style=color:#e6db74>&#39;&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>date</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>datetime</span>.<span style=color:#a6e22e>substr</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>8</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>method</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;GET&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>protocol</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;wss&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>uri</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/mqtt&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>service</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;iotdevicegateway&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>algorithm</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;AWS4-HMAC-SHA256&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>credentialScope</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>date</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;/&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>region</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;/&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>service</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;/&#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;aws4_request&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>canonicalQuerystring</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;X-Amz-Algorithm=&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>algorithm</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>canonicalQuerystring</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;&amp;X-Amz-Credential=&#39;</span> <span style=color:#f92672>+</span> encodeURIComponent(<span style=color:#a6e22e>credentials</span>.<span style=color:#a6e22e>accessKeyId</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;/&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>credentialScope</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>canonicalQuerystring</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;&amp;X-Amz-Date=&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>datetime</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>canonicalQuerystring</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;&amp;X-Amz-SignedHeaders=host&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>canonicalHeaders</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;host:&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>host</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;\n&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>payloadHash</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>AWS</span>.<span style=color:#a6e22e>util</span>.<span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>sha256</span>(<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#e6db74>&#39;hex&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>canonicalRequest</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>method</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;\n&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>uri</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;\n&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>canonicalQuerystring</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;\n&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>canonicalHeaders</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;\nhost\n&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>payloadHash</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>stringToSign</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>algorithm</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;\n&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>datetime</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;\n&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>credentialScope</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;\n&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>AWS</span>.<span style=color:#a6e22e>util</span>.<span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>sha256</span>(<span style=color:#a6e22e>canonicalRequest</span>, <span style=color:#e6db74>&#39;hex&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>signingKey</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>SigV4Utils</span>.<span style=color:#a6e22e>getSignatureKey</span>(<span style=color:#a6e22e>credentials</span>.<span style=color:#a6e22e>secretAccessKey</span>, <span style=color:#a6e22e>date</span>, <span style=color:#a6e22e>region</span>, <span style=color:#a6e22e>service</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>signature</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>AWS</span>.<span style=color:#a6e22e>util</span>.<span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>hmac</span>(<span style=color:#a6e22e>signingKey</span>, <span style=color:#a6e22e>stringToSign</span>, <span style=color:#e6db74>&#39;hex&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>canonicalQuerystring</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;&amp;X-Amz-Signature=&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>signature</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>credentials</span>.<span style=color:#a6e22e>sessionToken</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>canonicalQuerystring</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;&amp;X-Amz-Security-Token=&#39;</span> <span style=color:#f92672>+</span> encodeURIComponent(<span style=color:#a6e22e>credentials</span>.<span style=color:#a6e22e>sessionToken</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>requestUrl</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>protocol</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;://&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>host</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>uri</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;?&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>canonicalQuerystring</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>requestUrl</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><ul><li><code>host</code>: IoT的endpoint, 例如：ag35axgb1wdct.iot.ap-northeast-1.amazonaws.com</li><li><code>region</code>: IoT service所在區域，例如：ap-northeast-1</li><li><code>credentials</code>: accessKeyId, secretAccessKey, sessionToken(optional) IAM角色的公私鑰</li></ul><blockquote><p>client side</p></blockquote><ul><li>前端只要利用API的方式去向server取的IoT url並取代掉<code>{URL_FROM_SERVER}</code>就可以進行連線。修改連線的topic只需要取代掉<code>Test/chat</code>即可。</li></ul><pre tabindex=0><code class="language-htmlmixed=" data-lang="htmlmixed=">&lt;!DOCTYPE html&gt;
&lt;html lang=&#34;EN&#34;&gt;

&lt;head&gt;
    &lt;meta content=&#34;text/html;charset=utf-8&#34; http-equiv=&#34;Content-Type&#34;&gt;
    &lt;meta content=&#34;utf-8&#34; http-equiv=&#34;encoding&#34;&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;ul id=&#34;chat&#34;&gt;
        &lt;li v-for=&#34;m in messages&#34;&gt;{{ m }}&lt;/li&gt;
    &lt;/ul&gt;
    &lt;input type=&#34;text&#34; name=&#34;say&#34; id=&#34;say&#34; placeholder=&#34;Input a message here...&#34;&gt;
    &lt;button id=&#34;send&#34;&gt;Send&lt;/button&gt;

    &lt;script src=&#34;https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.16/vue.min.js&#34; type=&#34;text/javascript&#34;&gt;&lt;/script&gt;
    &lt;script src=&#34;https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js&#34; type=&#34;text/javascript&#34;&gt;&lt;/script&gt;
    &lt;script src=&#34;https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/core-min.js&#34; type=&#34;text/javascript&#34;&gt;&lt;/script&gt;
    &lt;script src=&#34;https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/hmac-min.js&#34; type=&#34;text/javascript&#34;&gt;&lt;/script&gt;
    &lt;script src=&#34;https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/sha256-min.js&#34; type=&#34;text/javascript&#34;&gt;&lt;/script&gt;
    &lt;script src=&#34;https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js&#34; type=&#34;text/javascript&#34;&gt;&lt;/script&gt;
    &lt;script type=&#34;text/javascript&#34;&gt;
        var data = {
            messages: []
        };
        new Vue({
            el: &#39;#chat&#39;,
            data: data
        });
        document.getElementById(&#39;send&#39;).addEventListener(&#39;click&#39;, function (e) {
            var say = document.getElementById(&#39;say&#39;)
            send(say.value);
            say.value = &#39;&#39;;
        });
var clientId = Math.random().toString(36).substring(7);
        var client = new Paho.MQTT.Client({URL_FROM_SERVER}, clientId);
        var topicName = &#39;Test/chat&#39;;
        var connectOptions = {
            useSSL: true,
            timeout: 3,
            mqttVersion: 4,
            onSuccess: subscribe
        };
        client.connect(connectOptions);
        client.onMessageArrived = onMessage;
        client.onConnectionLost = function (e) { console.log(e) };
        function subscribe() {
            client.subscribe(topicName);
            console.log(&#34;subscribed on Topic&#34;, topicName);
        }
        function send(content) {
            var message = new Paho.MQTT.Message(content);
            message.destinationName = topicName;
            client.send(message);
            console.log(&#34;sent to Topic&#34;, topicName);
        }
        function onMessage(message) {
            data.messages.push(message.payloadString);
            console.log(&#34;message received: &#34; + message.payloadString);
        }
    &lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre><ul class=pa0><li class="list di"><a href=/tags/aws class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">AWS</a></li><li class="list di"><a href=/tags/iot class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">IoT</a></li><li class="list di"><a href=/tags/websocket class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">websocket</a></li><li class="list di"><a href=/tags/sigv4 class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">SigV4</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Related</p><ul class="pa0 list"><li class=mb2><a href=/posts/aws_iot_advance/>AWS IoT | 進階資訊分享</a></li><li class=mb2><a href=/posts/aws_iot/>AWS IoT介紹</a></li><li class=mb2><a href=/posts/aws_lambda_dev_offline/>Serverless offline 開發設定 - 基礎篇</a></li><li class=mb2><a href=/posts/aws_project_development/>在Local machine開發AWS serverless project</a></li></ul></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://ggfu0114.github.io/>&copy; GGfu Personal Study - 學習筆記 2022</a><div><div class=ananke-socials></div></div></div></footer></body></html>