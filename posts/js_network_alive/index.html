<!doctype html><html lang=zh-tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Javascript detect network connect status | GGfu Personal Study - 學習筆記</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="當我們在開發網站時，可能會遇到需要偵測網路情況，給予使用者是當的反饋。例如做檔案上傳時，如果網路斷線又回復連接時，需要提醒使用者可以做續傳的動作"><meta name=generator content="Hugo 0.100.2"><meta name=robots content="index, follow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="Javascript detect network connect status"><meta property="og:description" content="當我們在開發網站時，可能會遇到需要偵測網路情況，給予使用者是當的反饋。例如做檔案上傳時，如果網路斷線又回復連接時，需要提醒使用者可以做續傳的動作"><meta property="og:type" content="article"><meta property="og:url" content="https://ggfu0114.github.io/posts/js_network_alive/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-12-31T00:00:00+00:00"><meta property="article:modified_time" content="2020-12-31T00:00:00+00:00"><meta itemprop=name content="Javascript detect network connect status"><meta itemprop=description content="當我們在開發網站時，可能會遇到需要偵測網路情況，給予使用者是當的反饋。例如做檔案上傳時，如果網路斷線又回復連接時，需要提醒使用者可以做續傳的動作"><meta itemprop=datePublished content="2020-12-31T00:00:00+00:00"><meta itemprop=dateModified content="2020-12-31T00:00:00+00:00"><meta itemprop=wordCount content="138"><meta itemprop=keywords content="Javascript,httprequest,network,online,offline,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Javascript detect network connect status"><meta name=twitter:description content="當我們在開發網站時，可能會遇到需要偵測網路情況，給予使用者是當的反饋。例如做檔案上傳時，如果網路斷線又回復連接時，需要提醒使用者可以做續傳的動作"></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">GGfu Personal Study - 學習筆記</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/categories/ title="Category page">Category</a></li></ul><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">Javascript detect network connect status</h1><p class=tracked>By <strong>GGFU</strong></p><time class="f6 mv4 dib tracked" datetime=2020-12-31T00:00:00Z>December 31, 2020</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h1 id=js-detect-network-connect-status>[JS] detect network connect status</h1><ul><li>當我們在開發網站時，可能會遇到需要偵測網路情況，給予使用者是當的反饋。例如做檔案上傳時，如果網路斷線又回復連接時，需要提醒使用者可以做續傳的動作。目前市面上多樣的瀏覽器所提供的<code>online</code>/<code>offline</code>事件，可能沒有辦法有效的偵測到。</li></ul><p>:::warning
It is important to note that this event and attribute are inherently unreliable. A computer can be connected to a network without having Internet access.
:::</p><ul><li>目前各家瀏覽器針對 &ldquo;Offline&rdquo; 的定義都不相同，所以沒有一個有效率的方式可偵測瀏覽器的網路情況。斷線的定義位於broswer當電腦在受保護的私人網路下，所以沒有連線到外界網路的能力，要定義為Offline嗎？ 都沒接上網路但是client和server端都在127.0.0.1網段，可以互相溝通要算有網路嗎？</li></ul><p>一般開發網站時可能比較需要偵測連線到外埠網路的情況，所以下面是一斷偵測網路連線狀態的 example code。藉由嘗試存取自己網站的favicon.ico去判定對是否有網路的連線能力，我們透過 httprequest 的 HEADER method 去嘗試，再這個 method 下比較節省流量。<a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods>HTTP Method</a>
:::warning
The HEAD method asks for a response identical to that of a GET request, but without the response body
:::</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>doesConnectionExist</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>xhr</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>XMLHttpRequest</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;https://example.com/favicon.ico&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>randomNum</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>round</span>(Math.<span style=color:#a6e22e>random</span>() <span style=color:#f92672>*</span> <span style=color:#ae81ff>10000</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>processRequest</span>() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>readyState</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>4</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>!==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>resolve</span>({ <span style=color:#a6e22e>net</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;connect&#39;</span>, <span style=color:#a6e22e>time</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> Date() });
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>resolve</span>({ <span style=color:#a6e22e>net</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;disconnect&#39;</span>, <span style=color:#a6e22e>time</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> Date() });
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>timeout</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2000</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>open</span>(<span style=color:#e6db74>&#39;HEAD&#39;</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>url</span><span style=color:#e6db74>}</span><span style=color:#e6db74>?rand=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>randomNum</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>send</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>addEventListener</span>(<span style=color:#e6db74>&#39;readystatechange&#39;</span>, <span style=color:#a6e22e>processRequest</span>, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul class=pa0><li class="list di"><a href=/tags/javascript class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Javascript</a></li><li class="list di"><a href=/tags/httprequest class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">httprequest</a></li><li class="list di"><a href=/tags/network class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">network</a></li><li class="list di"><a href=/tags/online class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">online</a></li><li class="list di"><a href=/tags/offline class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">offline</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Related</p><ul class="pa0 list"><li class=mb2><a href=/posts/aws_lambda_dev_offline/>Serverless offline 開發設定 - 基礎篇</a></li></ul></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://ggfu0114.github.io/>&copy; GGfu Personal Study - 學習筆記 2022</a><div><div class=ananke-socials></div></div></div></footer></body></html>