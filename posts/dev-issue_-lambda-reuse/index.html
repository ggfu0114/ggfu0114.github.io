<!doctype html><html lang=zh-tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=google-site-verification content="pnTK47Sz1tOdy6JvEhg4vyljdZ7i9uljteeuHXxekyY"><title>Dev issue: Lambda reuse | GGfu Personal Study - 學習筆記</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Dev issue: Lambda reuse"><meta name=generator content="Hugo 0.101.0"><meta name=robots content="index, follow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="Dev issue: Lambda reuse "><meta property="og:description" content="Dev issue: Lambda reuse"><meta property="og:type" content="article"><meta property="og:url" content="https://ggfu0114.github.io/posts/dev-issue_-lambda-reuse/"><meta property="article:section" content="posts"><meta itemprop=name content="Dev issue: Lambda reuse "><meta itemprop=description content="Dev issue: Lambda reuse"><meta itemprop=wordCount content="121"><meta itemprop=keywords content="AWS,Lambda,reuse,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Dev issue: Lambda reuse "><meta name=twitter:description content="Dev issue: Lambda reuse"></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">GGfu Personal Study - 學習筆記</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/categories/ title="Category page">Category</a></li></ul><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">Dev issue: Lambda reuse</h1><p class=tracked>By <strong>GGFU</strong></p></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><ul><li>當系統透過 APIGateway 呼叫 Lambda 執行時，我以為Lambda會<code>全部</code>重新執行打包好的程式。所以開發時，我們將 database connection 物件當成 Global 物件使用，認為每次重新呼叫 Lambda 都會全部重新生成物件。因為這個觀念而導致系統錯誤，當 Project 的物件被 require 後或變成 global 參數，再次執行 Lambda container 會出現 reuse 特性，將不會再被重新執行而生成新物件，以下是一個範例。</li></ul><blockquote><p>DB 的 client 為 global 物件</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>pg</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;pg&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>client</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>pg</span>.<span style=color:#a6e22e>Client</span>(<span style=color:#e6db74>&#39;postgres://myrds:5432/dbname&#39;</span>);  
</span></span><span style=display:flex><span><span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>connect</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>context</span>, <span style=color:#a6e22e>cb</span>) =&gt; {  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>test_print</span>} <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./example_module&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>test_print</span>();
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>query</span>(<span style=color:#e6db74>&#39;SELECT * FROM users WHERE &#39;</span>, (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>users</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Do stuff with users
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cb</span>(<span style=color:#66d9ef>null</span>); <span style=color:#75715e>// Finish the function cleanly
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  });
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><ul><li>上面的範例，因為 client 為 global物件，所以如果在程式裡面有 disconnect client 的狀況下，再次執行 Lambda 就會出現錯誤，因為 client 物件沒被重新 connect。</li></ul><blockquote><p>Global 程式不會每次都被執行</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;init the test module.&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span><span style=color:#f92672>=</span> {  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>test_print</span>(){
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;test&#39;</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>在 handler 裏面如果去 require module，module一旦被載入後就會被保留 reuse 用途，所以執行第二次 &lsquo;init the test module.&rsquo; 字串就不會再出現。</p><ul><li><a href=http://blog.rowanudell.com/database-connections-in-lambda/>Database Connections in Lambda</a></li><li><a href=https://aws.amazon.com/tw/blogs/compute/container-reuse-in-lambda/>Understanding Container Reuse in AWS Lambda</a></li></ul><ul class=pa0><li class="list di"><a href=/tags/aws class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">AWS</a></li><li class="list di"><a href=/tags/lambda class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Lambda</a></li><li class="list di"><a href=/tags/reuse class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">reuse</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Related</p><ul class="pa0 list"><li class=mb2><a href=/posts/deploy-s3-bucket-by-cloudformation/>Deploy s3 bucket by cloudformation</a></li><li class=mb2><a href=/posts/%E6%94%B6%E9%9B%86-aws-iot-data%E5%88%B0-aws-kinesis-%E8%99%95%E7%90%86%E8%B3%87%E6%96%99%E6%B5%81/>收集 AWS IoT data到 AWS kinesis 處理資料流</a></li><li class=mb2><a href=/posts/aws_iot_websocket/>AWS IoT with websocket</a></li><li class=mb2><a href=/posts/aws_iot_advance/>AWS IoT | 進階資訊分享</a></li><li class=mb2><a href=/posts/aws_iot/>AWS IoT介紹</a></li><li class=mb2><a href=/posts/aws_lambda_dev_offline/>Serverless offline 開發設定 - 基礎篇</a></li><li class=mb2><a href=/posts/aws_project_development/>在Local machine開發AWS serverless project</a></li></ul></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://ggfu0114.github.io/>&copy; GGfu Personal Study - 學習筆記 2022</a><div><div class=ananke-socials></div></div></div></footer></body></html>