<!doctype html><html lang=zh-tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Ceph Cluster Storage 初階學習 | GGfu Personal Study - 學習筆記</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="學習Ceph storage的基本資訊與如何安裝系統"><meta name=generator content="Hugo 0.100.2"><meta name=robots content="index, follow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="Ceph Cluster Storage 初階學習"><meta property="og:description" content="學習Ceph storage的基本資訊與如何安裝系統"><meta property="og:type" content="article"><meta property="og:url" content="https://ggfu0114.github.io/posts/ceph_beginner/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-12-31T00:00:00+00:00"><meta property="article:modified_time" content="2020-12-31T00:00:00+00:00"><meta itemprop=name content="Ceph Cluster Storage 初階學習"><meta itemprop=description content="學習Ceph storage的基本資訊與如何安裝系統"><meta itemprop=datePublished content="2020-12-31T00:00:00+00:00"><meta itemprop=dateModified content="2020-12-31T00:00:00+00:00"><meta itemprop=wordCount content="204"><meta itemprop=keywords content="Ceph,CRUSH,straw,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Ceph Cluster Storage 初階學習"><meta name=twitter:description content="學習Ceph storage的基本資訊與如何安裝系統"></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">GGfu Personal Study - 學習筆記</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/categories/ title="Category page">Category</a></li></ul><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">Ceph Cluster Storage 初階學習</h1><p class=tracked>By <strong>GGFU</strong></p><time class="f6 mv4 dib tracked" datetime=2020-12-31T00:00:00Z>December 31, 2020</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h2 id=ceph-元件>Ceph 元件</h2><ol><li>MON (monitor):<ul><li>維護整個cluster的狀態</li><li>透過crush演算法取得osd位置，執行建立與傳輸資料</li><li>不會主動的輪詢OSD的各種狀態</li><li>保證cluster所有數據的一致性</li><li>單一可運行，建議可部署多個，每個node上最多只能有一個MON</li></ul></li><li>OSD (ObjectStorageDevice)<ul><li>cluster中的資料的儲存體
- 當OSD發現自身或其他OSD發生異常時會上報MON
- 對其他的OSD發送heart beat訊號</li></ul></li><li>MGR</li><li>MDS<ul><li>使用CephFS才需要使用此服務
- 提供資料運算，緩存和資料同步</li></ul></li></ol><p>Ceph RGW(即RADOS Gateway)是Ceph对象存储网关服务，是基于LIBRADOS接口封装实现的FastCGI服务，对外提供存储和管理对象数据的Restful API。
<img src=ceph-rgw.png alt></p><p>安裝osd時有錯誤發生，發現log的描述如下：
** ERROR: osd init failed: (36) File name too long
原因：
Ceph官方建議用XFS作OSD的文件系統，如果安裝OSD主機上的文件系統格式為ext4，會使得OSD的資料不能安全的保存。所以要解決這個問題就得：</p><ol><li>將安裝OSD的文件系統改為XFS</li><li>修改OSD的文件配置，然後重新啟動OSD</li></ol><pre tabindex=0><code>osd max object name len = 256 
osd max object namespace len = 64 
</code></pre><p>用來檢查Ceph目前的狀態</p><pre tabindex=0><code>ceph -s
</code></pre><p>當Ceph系統都已經架設完畢時，可以安裝ceph-fuse作為Client端掛載到monitor機器上
sudo apt-get install ceph-fuse</p><pre tabindex=0><code>$ ceph- fuse -m 192.168.0.1:6789 /fuse_folder/
</code></pre><p>系統都已設定完畢，但是使用ceph-fuse出現</p><pre tabindex=0><code>mount failed: (110) Connection timed out
</code></pre><p>安裝Ceph的作業系統為<code>Ubuntu (14.04.4 LTS, Trusty Tahr)</code>
使用-d去debug時，會出現以下訊號</p><pre tabindex=0><code>2018-03-13 10:20:03.234048 7f90c64cf700  0 -- 192.168.100.65:0/2082429148 &gt;&gt; 192.168.100.65:6789/0 pipe(0x55e333394b00 sd=0 :58114 s=1 pgs=0 cs=0 l=1 c=0x55e333394d90).connect protocol feature mismatch, my 2fffffffffff &lt; peer 10ff8eea4fffb missing 401000000000000
</code></pre><p>主要的原因是CRUSH演算法的問題：
missing 401000000000000 = CEPH_FEATURE_CRUSH_V4(1000000000000)+CEPH_FEATURE_NEW_OSDOPREPLY_ENCODING(400000000000000)
CRUSH 的演算法用來計算資料的儲存位置，用來確定儲存與檢索。CRUSH授予client端可以存取OSD，避免單點故障，性能的限制，與系統擴展的限制。CRUSH裡面有一張Map，可以把資料平均隨機的散布到各個OSD裡。</p><p>當前內核的版本缺乏 CEPH_FEATURE_CRUSH_V4 這個特性，查表 > <a href="'http://cephnotes.ksperis.com/blog/2014/01/21/feature-set-mismatch-error-on-ceph-kernel-client/'">feature set mismatch</a></p><p>解決辦法：修改crushmap，將straw2改成straw</p><pre tabindex=0><code>$ ceph osd crush show-tunables #查訊目前tunables的參數
$ ceph osd crush tunables hammer #調整tunables至hammer
$ ceph osd crush dump|grep alg #查詢當前的crush演算法
#修改crush map 里面的bucket的alg
$ ceph osd getcrushmap -o crushmap.txt
$ crushtool -d crushmap.txt -o crushmap-decompile
$ vim crushmap-decompile
$ crushtool -c crushmap-decompile  -o crushmap-compile
$ ceph osd setcrushmap -i crushmap-compile
</code></pre><h2 id=ceph-plugin>Ceph plugin</h2><ul><li>dashboard
在 Luminous August 2017以後的 Development 版本，都有提供dashboard的功能，可以用網頁的方式去監控 Ceph的 狀態，安裝好Ceph的系統後，只需要enable模組即可。</li></ul><pre tabindex=0><code>ceph mgr module enable dashboard
</code></pre><p>預設的網頁server會綁定在：
如果有需要更改IP或PORT可以用以下方去做調整</p><pre tabindex=0><code>ceph config-key set mgr/dashboard/server_addr $IP
ceph config-key set mgr/dashboard/server_port $PORT
</code></pre><p><a href="'http://docs.ceph.com/docs/master/mgr/dashboard/'">Ceph Dashboard 官網</a></p><ul class=pa0><li class="list di"><a href=/tags/ceph class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Ceph</a></li><li class="list di"><a href=/tags/crush class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">CRUSH</a></li><li class="list di"><a href=/tags/straw class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">straw</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://ggfu0114.github.io/>&copy; GGfu Personal Study - 學習筆記 2022</a><div><div class=ananke-socials></div></div></div></footer></body></html>