<!doctype html><html lang=zh-tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>PgPool2 install issu 紀錄安裝過程 | GGfu Personal Study - 學習筆記</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="PgPool2 install issu 紀錄安裝過程"><meta name=generator content="Hugo 0.100.2"><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="PgPool2 install issu 紀錄安裝過程"><meta property="og:description" content="PgPool2 install issu 紀錄安裝過程"><meta property="og:type" content="article"><meta property="og:url" content="https://ggfu0114.github.io/posts/pgpool2-install-issu-%E7%B4%80%E9%8C%84%E5%AE%89%E8%A3%9D%E9%81%8E%E7%A8%8B/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-06T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-06T00:00:00+00:00"><meta itemprop=name content="PgPool2 install issu 紀錄安裝過程"><meta itemprop=description content="PgPool2 install issu 紀錄安裝過程"><meta itemprop=datePublished content="2022-03-06T00:00:00+00:00"><meta itemprop=dateModified content="2022-03-06T00:00:00+00:00"><meta itemprop=wordCount content="408"><meta itemprop=keywords content="postgres ha,pgpool,hba,replication`,"><meta name=twitter:card content="summary"><meta name=twitter:title content="PgPool2 install issu 紀錄安裝過程"><meta name=twitter:description content="PgPool2 install issu 紀錄安裝過程"></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">GGfu Personal Study - 學習筆記</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/categories/ title="Category page">Category</a></li></ul><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">PgPool2 install issu 紀錄安裝過程</h1><p class=tracked>By <strong>GGFU</strong></p><time class="f6 mv4 dib tracked" datetime=2022-03-06T00:00:00Z>March 6, 2022</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h2 id=安裝pgpool-ii>安裝pgpool-II</h2><p>透過網路上簡易的git repostory去快速的安裝pgpool-2 docker環境
例如：<a href=https://github.com/lzalewsk/docker-pgpool2>docker-pgpool2</a></p><ol><li>將pgpool conf檔跟執行的shell複製進去docker裡面</li><li>執行pgpool</li></ol><p>需要在postgres建立pgpool所需要登入的角色，例如使用者：pgpool</p><p>利用指令可以查詢現在postgres node status:</p><pre tabindex=0><code>pcp_node_info [option...] [node_id]
pcp_node_info --verbose -h localhost -U postgres 0
</code></pre><h3 id=問題>問題</h3><ul><li><p>出現<code>2018-09-18 05:32:46: pid 6: FATAL: could not open pid file as /var/run/pgpool/pgpool.pid. reason: No such file or directory</code>的錯誤訊息
需要幫process建立/var/run/pgpool的資料夾</p></li><li><p>pgpool都已經裝好，postgres sever也已經就緒，但是出現無法登入的問題，相同帳號密碼不透過pgpool會登入成功？</p></li><li><p>看了一下pgpool2的log檔，出現以下資訊</p></li></ul><pre tabindex=0><code>2018-07-27 06:51:28 DEBUG: pid 30: I am 30 accept fd 5
2018-07-27 06:51:28 LOG:   pid 30: connection received: host=192.168.17.178 port=64325
2018-07-27 06:51:28 DEBUG: pid 30: Protocol Major: 1234 Minor: 5679 database:  user: 
2018-07-27 06:51:28 DEBUG: pid 30: SSLRequest from client
2018-07-27 06:51:28 DEBUG: pid 30: read_startup_packet: application_name: pgAdmin 4 - DB:postgres
2018-07-27 06:51:28 DEBUG: pid 30: Protocol Major: 3 Minor: 0 database: postgres user: postgres
2018-07-27 06:51:28 DEBUG: pid 30: new_connection: connecting 0 backend
2018-07-27 06:51:28 DEBUG: pid 30: new_connection: skipping slot 0 because backend_status = 0
2018-07-27 06:51:28 DEBUG: pid 30: new_connection: connecting 1 backend
2018-07-27 06:51:28 DEBUG: pid 30: pool_read_message_length: slot: 1 length: 12
2018-07-27 06:51:28 DEBUG: pid 30: pool_do_auth: auth kind:5
2018-07-27 06:51:28 DEBUG: pid 30: trying md5 authentication
2018-07-27 06:51:28 ERROR: pid 30: pool_get_passwd: username is NULL
2018-07-27 06:51:28 DEBUG: pid 30: do_md5: (null) does not exist in pool_passwd
2018-07-27 06:51:28 DEBUG: pid 30: do_md5failed in slot 1
</code></pre><ul><li><p>正常普通安裝pgpool，設定檔的路徑會出現在<code>/etc/pgpool2</code>，通常會有四個檔案，<code>pcp.conf</code> <code>pgpool.conf</code> <code>pool_hba.conf</code> <code>pool_passwd</code></p></li><li><p>處理這個問題需要檢查幾個步驟：</p></li></ul><ol><li><code>pgpool.conf</code>: 是否enable_pool_hba有開啟</li></ol><pre tabindex=0><code># - Authentication -

enable_pool_hba = on
                                   # Use pool_hba.conf for client authentication
pool_passwd = &#39;pool_passwd&#39;
                                   # File name of pool_passwd for md5 authentication.
                                   # &#34;&#34; disables pool_passwd.
                                   # (change requires restart)
authentication_timeout = 60
                                   # Delay in seconds to complete client authentication
                                   # 0 means no timeout.
</code></pre><ol start=2><li><code>pool_hba.conf</code>: hba為host-based authentication的縮寫，這個檔案規範了哪些client可以存取哪些資料庫跟認證的方式，因為實驗關係，我將local全開，從外部連線進來的則需要透過md5驗證</li></ol><pre tabindex=0><code># TYPE  DATABASE    USER        CIDR-ADDRESS          METHOD
# &#34;local&#34; is for Unix domain socket connections only
local   all         all                               trust
# IPv4 local connections:
host    all         all         0.0.0.0/0               md5
</code></pre><ol start=3><li><code>pool_passwd</code>: pgpool2是個中介角色，所以並不知道使用者的帳號密碼，所以需要在這邊建立可以存取pool的帳號密碼(當然帳號密碼要跟登入postgres的相同)</li></ol><pre tabindex=0><code># FORMAT: &#34;username:encrypted_passwd&#34;
postgres:md56805f0aa765be4366313b21228496be1
</code></pre><p>md5後的密碼可以用兩種方式產生:</p><ul><li><code>pg_md5 --md5auth --username=&lt;username> &lt;passowrd></code>
密碼會自動地加入到pool_passwd檔案裡，或是到postres查詢</li><li><code>select * from pg_shadow;</code></li></ul><h1 id=postgres-ha>Postgres HA</h1><p>分別建立master與slave的postgres，然後執行slave作為master的replication的node時出現以下的錯誤</p><pre tabindex=0><code>FATAL:database system identifier differs between the primary and standby
</code></pre><p>在slave的node，PG DATA需要由master的node複製過來才會有相同的identifier</p><p>在master-slave模式下將master關閉時，在slave log上會出現以下的錯誤訊息，slave會一直嘗試連線上去master，因為目前slave是沒有寫入的能力的</p><pre tabindex=0><code>FATAL:  could not connect to the primary server: could not connect to server: Connection refused
                Is the server running on host &#34;192.168.0.100&#34; and accepting
                TCP/IP connections on port 5432?
</code></pre><p>使用pg_basebackup進行資料備份一直出現：
<code>no pg_hba.conf entry for replication connection from host "192.168.21.171", user "ubuntu", SSL off</code>
明明pg_hba.conf已經是，應該是所有連線只要有打密碼都可以連線上，但是情況是怎麼都會出現ERROR</p><pre tabindex=0><code># TYPE  DATABASE        USER            ADDRESS                 METHOD
host all all all md5
</code></pre><p>原因：
需要在pg_hba加上以下這條rule，如果是replication connection，DATABASE的欄位一定是填replication。
<code>host replication replicator all md5</code></p><h1 id=pgpool2-ha>Pgpool2 HA</h1><p>PGool透過watch dog開啟heartbeat模式互相偵測node彼此是否存活，搭配上Virtual IP去指定一個沒在使用的IP作為connect連接的入口，一旦active pgpool出現問題時，watchdog會請其他stanby的node建立Virtual IP的網路，取代原本active node.</p><h3 id=開啟wd模式>開啟wd模式</h3><p><a href=http://www.pgpool.net/docs/latest/en/html/example-watchdog.html>example-watchdog</a>
上面的連結有介紹了如何透過修改<code>pgpool.conf</code>去啟用watch dog功能
實驗過程出現以下錯誤：</p><pre tabindex=0><code>SIOCSIFADDR: Operation not permitted 
SIOCSIFFLAGS: Operation not permitted 
SIOCSIFNETMASK: Operation not permitted 
</code></pre><p>因為pgpool是在docker container執行，所以沒有network變更權限，需要在run container時加上 -privileged</p><p><a href=http://www.pgpool.net/docs/pgpool-II-3.2.1/pgpool-zh_cn.html>簡中pgpool.conf說明</a></p><ul class=pa0><li class="list di"><a href=/tags/postgres-ha class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">postgres ha</a></li><li class="list di"><a href=/tags/pgpool class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">pgpool</a></li><li class="list di"><a href=/tags/hba class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">hba</a></li><li class="list di"><a href=/tags/replication class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">replication`</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://ggfu0114.github.io/>&copy; GGfu Personal Study - 學習筆記 2022</a><div><div class=ananke-socials></div></div></div></footer></body></html>