<!doctype html><html lang=zh-tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>AWS IoT | 進階資訊分享 | GGfu Personal Study - 學習筆記</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="在 AWS IoT的資源上，有部份的 topic name是被保留，並寫說明用IoT service 驅動lambda."><meta name=generator content="Hugo 0.100.2"><meta name=robots content="index, follow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="AWS IoT | 進階資訊分享"><meta property="og:description" content="在 AWS IoT的資源上，有部份的 topic name是被保留，並寫說明用IoT service 驅動lambda."><meta property="og:type" content="article"><meta property="og:url" content="https://ggfu0114.github.io/posts/aws_iot_advance/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-12-31T00:00:00+00:00"><meta property="article:modified_time" content="2020-12-31T00:00:00+00:00"><meta itemprop=name content="AWS IoT | 進階資訊分享"><meta itemprop=description content="在 AWS IoT的資源上，有部份的 topic name是被保留，並寫說明用IoT service 驅動lambda."><meta itemprop=datePublished content="2020-12-31T00:00:00+00:00"><meta itemprop=dateModified content="2020-12-31T00:00:00+00:00"><meta itemprop=wordCount content="179"><meta itemprop=keywords content="AWS,IoT,lambda,topic,"><meta name=twitter:card content="summary"><meta name=twitter:title content="AWS IoT | 進階資訊分享"><meta name=twitter:description content="在 AWS IoT的資源上，有部份的 topic name是被保留，並寫說明用IoT service 驅動lambda."></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">GGfu Personal Study - 學習筆記</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/categories/ title="Category page">Category</a></li></ul><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">AWS IoT | 進階資訊分享</h1><p class=tracked>By <strong>GGFU</strong></p><time class="f6 mv4 dib tracked" datetime=2020-12-31T00:00:00Z>December 31, 2020</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h1 id=aws-iot---進階>AWS IoT - 進階</h1><h3 id=iot-reserved-topic>IoT reserved topic</h3><ul><li>在 AWS IoT的資源上，有部份的 topic name是被保留。</li></ul><p><code>$aws/events/presence/connected/#</code> : 如果有任何的使用者連上 IoT 就會推播訊息到這個 Topic
<code>$aws/events/presence/disconnected/#</code>: 如果有任何的使用者斷線,就會推播訊息</p><ul><li>這個是當使用者 connected/disconnected 推播到 topic 裡的訊息範例</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;clientId&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;timestamp&#34;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1460065214626</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;eventType&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;connected&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;sessionIdentifier&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;00000000-0000-0000-0000-000000000000&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;principalIdentifier&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;000000000000/ABCDEFGHIJKLMNOPQRSTU:some-user/ABCDEFGHIJKLMNOPQRSTU:some-user&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>$aws/events/subscriptions/subscribed/#</code>: 如果有任何的使用者訂閱了任何的 topic就會推播訊息到這個topic
<code>$aws/events/subscriptions/unsubscribed/#</code>： 如果有任何的使用者解訂閱了任何的 topic就會推播訊息</p><ul><li>這個是 subscribed/unsubscribed 推播的訊息範例</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;clientId&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;186b5&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;timestamp&#34;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1460065214626</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;eventType&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;subscribed&#34;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#34;unsubscribed&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;sessionIdentifier&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;00000000-0000-0000-0000-000000000000&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;principalIdentifier&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;000000000000/ABCDEFGHIJKLMNOPQRSTU:some-user/ABCDEFGHIJKLMNOPQRSTU:some-user&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;topics&#34;</span> <span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;foo/bar&#34;</span>,<span style=color:#e6db74>&#34;device/data&#34;</span>,<span style=color:#e6db74>&#34;dog/cat&#34;</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>:::info</p><h4 id=同時要聆聽相同-topic-底下不同的子-topic-可用--號串聯例如>同時要聆聽相同 Topic 底下不同的子 Topic 可用 + 號串聯，例如：</h4><p><code>$aws/events/subscriptions/+/#</code>: 可以同時聆聽到 connected, disconnected, subscribed, unsubscribed &mldr;的訊息
<code>company/+/member</code>： + 號可以是任意的字串，只要符合這個 Topic 的 name 的規則，都可以收到資訊
:::</p><h3 id=iot-trigger-lambda>IoT trigger lambda</h3><p>IoT 要 trigger lambda 需要先定義 rule，透過 rule 的定義去執行 Lambda和傳送對應的參數，rule包含兩個主要資訊
<code>query statement</code> 這個參數是拿來定義要傳入 lambda 的規則，例如：</p><pre tabindex=0><code class="language-sql=" data-lang="sql=">SELECT * as data FROM &#39;$aws/events/presence/connected/#&#39; 
/* 將所有 IoT 所收到的資料都傳進去 lambda 的參數裡 */

SELECT * as data, topic() as topic, clientid() as cliendId, timestamp() as timestamp FROM &#39;+/updateStatus&#39;
/* 所有傳送到 +/updateStatus 的資料，我們將 data, topic,clientid, ts 都傳入 lambda*/
</code></pre><p><code>actions</code> 用來定義要將哪隻 Lambda 驅動</p><ul><li><p>透過 AWS IoT 可手動選擇驅動的 Lambda
<img src=https://i.imgur.com/oUCBSsh.png alt></p></li><li><p>或是，用的是 serverless 套件去佈署 AWS resources，下面是一個佈署範例：</p></li></ul><pre tabindex=0><code class="language-yaml=" data-lang="yaml=">playerUpdateStatus:
    handler: handler.handler_function
    name: updateDeviceStatus
    description: IoT Device state
    events:
      - iot:
          name: UpdateDeviceRule
          sql: &#34;SELECT * as data FROM &#39;$aws/events/subscriptions/subscribed/#&#39;&#34;
          description: &#34;IoT Update Rule&#34;
</code></pre><ul class=pa0><li class="list di"><a href=/tags/aws class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">AWS</a></li><li class="list di"><a href=/tags/iot class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">IoT</a></li><li class="list di"><a href=/tags/lambda class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">lambda</a></li><li class="list di"><a href=/tags/topic class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">topic</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Related</p><ul class="pa0 list"><li class=mb2><a href=/posts/aws_iot_websocket/>AWS IoT with websocket</a></li><li class=mb2><a href=/posts/aws_iot/>AWS IoT介紹</a></li><li class=mb2><a href=/posts/aws_lambda_dev_offline/>Serverless offline 開發設定 - 基礎篇</a></li><li class=mb2><a href=/posts/aws_project_development/>在Local machine開發AWS serverless project</a></li><li class=mb2><a href=/posts/dev-issue_-lambda-reuse/>Dev issue: Lambda reuse</a></li></ul></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://ggfu0114.github.io/>&copy; GGfu Personal Study - 學習筆記 2022</a><div><div class=ananke-socials></div></div></div></footer></body></html>